<template>
  <div id="restoration-type">
    <div class="section-container" :class="{ 'invalid-section': invalidSection }">
      <v-row no-gutters>
        <v-col cols="12" sm="3" class="pr-4">
          <label :class="{ 'error-text': invalidSection }">
            <strong>Restoration Type</strong>
          </label>
        </v-col>

        <v-col cols="12" sm="9">
          <v-radio-group
            class="mt-0 pt-0"
            v-model="selectRestorationType"
            @change="changeRestorationType()"
          >
            <v-radio id="full-radio-button" label="Full Restoration" :value=RestorationTypes.FULL />

            <!-- Relationship To Company Checkboxes -->
            <v-expand-transition>
              <div v-if="isFull">
                <div class="ml-8">
                  Please select
                  <v-tooltip content-class="top-tooltip" transition="fade-transition" top>
                    <template v-slot:activator="{ on, attrs }">
                      <span class="dotted-underline" v-bind="attrs" v-on="on">
                        applicant's relationship
                      </span>
                    </template>
                    Full restoration application must be related to the dissolved business.
                  </v-tooltip>
                  to the company at the time the company was dissolved:
                </div>
                <RelationshipsPanel
                  :draftRelationships="getRestoration.relationships"
                  @changed="setRestorationRelationships($event)"
                  @valid="setRestorationTypeValid($event)"
                />
              </div>
            </v-expand-transition>

            <v-radio id="limited-radio-button" label="Limited Restoration" :value=RestorationTypes.LIMITED />

            <!-- Limited Restoration Radio Panel -->
            <v-expand-transition>
              <div v-if="isLimited">
                <LimitedRestorationPanel
                  :currentDate="getCurrentDate"
                  :expiryDate="getRestoration.expiry"
                  @expiry="setRestorationExpiry($event)"
                />
              </div>
            </v-expand-transition>
          </v-radio-group>
        </v-col>
      </v-row>
    </div>
  </div>
</template>

<script lang="ts">
import Vue from 'vue'
import { Component, Watch } from 'vue-property-decorator'
import { DateMixin, CommonMixin } from '@/mixins'
import { Getter, Action } from 'vuex-class'
import { RestorationTypes } from '@/enums'
import { RestorationStateIF } from '@/interfaces'
import { RelationshipsPanel } from '@bcrs-shared-components/relationships-panel'
import { LimitedRestorationPanel } from '@bcrs-shared-components/limited-restoration-panel'

@Component({
  mixins: [
    DateMixin,
    CommonMixin
  ],
  components: {
    RelationshipsPanel,
    LimitedRestorationPanel
  }
})
export default class RestorationType extends Vue {
  @Getter getCurrentDate!: string
  @Getter getRestoration!: RestorationStateIF
  @Getter getRestorationTypeValid!: boolean
  @Getter getShowErrors!: boolean

  @Action setRestorationExpiry!: ActionBindingIF
  @Action setRestorationRelationships!: ActionBindingIF
  @Action setRestorationType!: ActionBindingIF
  @Action setRestorationTypeValid!: ActionBindingIF

  // Local properties
  protected selectRestorationType: RestorationTypes = null

  // Enum for template
  readonly RestorationTypes = RestorationTypes

  /** Is true if current restoration is full. */
  get isFull (): boolean {
    return (this.getRestoration.type === RestorationTypes.FULL)
  }

  /** Is true if current restoration is limited. */
  get isLimited (): boolean {
    return (this.getRestoration.type === RestorationTypes.LIMITED)
  }

  /** This section's validity state (when prompted by app). */
  get invalidSection (): boolean {
    return (this.getShowErrors && !this.getRestorationTypeValid)
  }

  /**
   * Sets the selected Limited Restoration choice.
   * @param val the value of the selected radio button
   */
  protected changeRestorationType (): void {
    this.setRestorationType(this.selectRestorationType)
    if (this.isLimited) {
      this.setRestorationRelationships([])
    } else {
      this.setRestorationExpiry(null)
    }
  }

  /** Initially and when restoration type changes, updates local property. */
  @Watch('getRestoration.type', { immediate: true })
  private onRestorationType (val: RestorationTypes): void {
    this.selectRestorationType = val

    // if Limited, set validity to true
    // if Full then validity is set by RelationshipsPanel
    if (this.isLimited) this.setRestorationTypeValid(true)
  }
}
</script>
